---
layout: post
author: Yuto Nakamura
tags: [自作OS, RISC-V]
description: 
ogp_img:
title: RISC-Vにおけるタイマー割り込み
latex: false
date: 2023-06-27 17:00 +0900
---

簡単な自作OSを作り、それを動作させるCPUも同時に作成していくようにしているわけですが、学会などがあり少し時間が空いてしまいました。今回は、RISC-Vのタイマー割り込みについて調べたので、それについてまとめていきます。

## 割り込みとは
割り込みとは、CPUがプログラムを実行している間に、外部からの信号や、ソフトウェアからの要請によって、プログラムの実行を中断して、別の処理を行うことです。特に、タイマー割り込みとは、タイマーが指定した時間になったときや、一定時間おきに、割り込みを発生させることを言います。タイマー割り込みを使用することで、OSのスケジューリングや、プログラムの実行時間の計測などができます。

例えば、50msごとに割り込みを発生させるようにし、その度にタスクを切り替えるようにしておけば、簡単なプリエンティブスケジューリングができます。また、プログラムの実行時間を計測する場合は、割り込みを発生させ、その度にカウンタをインクリメントしていけば、プログラムの実行時間を計測することができます。

## RISC-Vの割り込み
RISC-Vにおける割り込みの発生と、その典型的なCPUの動作について触れます。まず、処理に関わってくる諸々のレジスタを整理します。ここでは、マシンモードでのハンドリングの際に使用されるレジスタを示しています。

- `mstatus` : グローバル割り込みが有効かなどの状態を表すレジスタ
- `mip` : 処理待ちになっている割り込みを表すレジスタ
- `mie` : 特定の割り込みが有効かを表すレジスタ
- `mtvec` : 割り込み/例外ハンドラのアドレスを表すレジスタ
- `mcause` : 割り込み/例外の原因を表すレジスタ
- `mepc` : 割り込み/例外が発生した命令のアドレスを表すレジスタ
- `mscratch` : ハンドラの実行中に使用することができる一時保存レジスタ
- `mtval` : 例外時に不正命令や、アドレスを格納するレジスタ。使用しないときは0にされている

割り込みが発生しているかどうかは、`mip`レジスタを見ればわかります。`mip`レジスタのあるbitが立てばそれに対応した割り込みが発生していることになります。対回り込み発生時のCPUの動作は以下のようになると思われます（順番は必ずしもこの順番ではないと思いますし、これであっているかも微妙ですが…）。

1. `mstatus`の`MIE`と`mie`の該当bitが立っていることを確認する。（すなわち、タイマ割り込みが可能であることを確認する）
2. `mcause`に割り込みの原因を格納する。
3. `mtval`の値を0にする。
4. `mepc`に現在のPCを格納する。
5. `mie`の該当bitを0にする。
6. `mstatus`の`MIE`を0にし、元の値を`MPIE`に格納する。
7. 現在の実行モードを`mstatus`の`MPP`に格納し、マシンモードに移行する。
8. PCの値を`mtvec`の値にする
9. 実行状態を保存する
10. ハンドラの実行
11. 実行状態を復元する
12. (`mret`を実行する)
    1.  `mstatus`を元に戻す。実行モードを元に戻す。
    2.  `mie`の該当bitを1にする。`mip`の該当bitを0にする。
    3.  PCを`mepc`から復元する。
13. 通常動作に戻る

ざっくりとこんな感じだと思います。CPUを扱う側（＝プログラムを書く側）は、

1. 割り込みが発生するとその原因が`mcause`に格納されている
2. 割り込みベクタに従ってハンドラが実行される
3. `mret`を実行すればもとの処理に戻る

という点を抑えておけば多分大丈夫でしょう。



## まとめ
`.sbss`及び`.sdata`セクションの意味とそのgpとの関係について、最適化が関わっていることに触れながらまとめました。最適化する際はこういうことを考えているんだなということがわかり、面白かったです。

---
{: data-content="footnotes"}
