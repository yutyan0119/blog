---
layout: post
author: Yuto Nakamura
tags: [crypto]
description: 
ogp_img:
title: SHA3ã‚’Rustã§å®Ÿè£…ã—ãŸ
latex: true
date: 2023-05-06
---

SHA3ã‚’Rustã§å®Ÿè£…ã—ã¾ã—ãŸã€‚ã¨ã„ã£ã¦ã‚‚ã€SHA3ãŒå®Ÿè£…ã—ãŸãã¦å®Ÿè£…ã—ãŸã‚ã‘ã§ã¯ãªãã€Crystals-Kyberã¨å‘¼ã°ã‚Œã‚‹æœ€æ–°ã®æš—å·æ–¹å¼ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã€SHA3ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§å®Ÿè£…ã—ãŸã¾ã§ã§ã™ã€‚ä»Šå›å®Ÿè£…ã—ãŸã€SHA3ã®å®Ÿè£…ã¯ã€[ã“ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/yutyan0119/Kyber-rs)ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯[`src/sha3.rs`](https://github.com/yutyan0119/Kyber-rs/blob/main/src/sha3.rs)ã«ã»ã¨ã‚“ã©ã®å®Ÿè£…ãŒã‚ã‚Šã¾ã™ã€‚

<aside class="msg message">
<span class="msg-symbol">ğŸ™„</span>
<div class="msg-content">
ã“ã®è¨˜äº‹ã¯ã‚ãã¾ã§ã‚‚å®Ÿè£…ã«é‡ãã‚’ç½®ãã ã‘ãªã®ã§ã€ã“ã®ãƒãƒƒã‚·ãƒ¥é–¢æ•°ãŒã„ã‹ã«ã‚»ã‚­ãƒ¥ã‚¢ã ã¨ã‹ã€ãã†ã„ã†é¢ã«è§¦ã‚Œã‚‹ã“ã¨ã¯æ®‹å¿µãªãŒã‚‰ã‚ã‚Šã¾ã›ã‚“â€¦
</div>
</aside>

## SHA3
Keccakï¼ˆã‚±ãƒãƒ£ãƒƒã‚¯ã¨èª­ã‚€ã‚‰ã—ã„ï¼‰ã¨ã„ã†ãƒãƒƒã‚·ãƒ¥é–¢æ•°ã‚’ç”¨ã„ãŸæ–°ã—ã„ãƒãƒƒã‚·ãƒ¥æ–¹å¼ã€‚SHA1, SHA2ã¨ã¯ç•°ãªã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚Keccakã¯ã‚ãã¾ã§ã‚‚ãƒãƒƒã‚·ãƒ¥åŒ–ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã€SHA3ãã®ã‚‚ã®ã¨ã¯ç•°ãªã‚‹ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚SHA3ã¯Keccakã®ä¸€éƒ¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å›ºå®šã—ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®æ–¹æ³•ãªã©ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚NISTã«ã‚ˆã£ã¦ã€æ¨™æº–åŒ–ã•ã‚ŒãŸæ¬¡ä¸–ä»£ã®ãƒãƒƒã‚·ãƒ¥æ–¹å¼ã‚„ï¼ã£ã¦æ„Ÿã˜ãŒã—ã¾ã™ã€‚[^1] SHA1ã¸ã®æ”»æ’ƒãŒç¢ºç«‹ã—ã¦åŒã˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®SHA2ã‚‚ã‚„ã°ã„ã‚“ã¡ã‚ƒã†ã‹ã¨ãªã£ã¦ç­–å®šã—ãŸãŒã€SHA2ã¯ä»Šã®ã¨ã“ã‚æœ‰åŠ¹ï¼ˆå¤šåˆ†ã“ã“ã§è¨€ã†æœ‰åŠ¹ã¯ç¾å®Ÿçš„ãªæ™‚é–“ã§åã¾ã‚‹ï¼‰ãªæ”»æ’ƒæ‰‹æ³•ãŒãªãã€ã¾ã ä½¿ãˆã‚‹ã‚‰ã—ã„ã€‚ã˜ã‚ƒã‚SHA3ã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã£ã¦ãªã‚“ã‚„ã£ã¦æ„Ÿã˜ã‚‚ã—ã¾ã™ãŒã€ã“ã£ã¡ã¯ã“ã£ã¡ã§å‡ºåŠ›é•·ã‚’å¯å¤‰ã«ã™ã‚‹SHAKEãŒæ¨™æº–åŒ–ã•ã‚Œã¦ãŸã‚Šã™ã‚‹ã‹ã‚‰ãã†ã„ã†éƒ¨åˆ†ã‚‚å«ã‚ã¦ãˆãˆã‚“ã‚„ã‚ã†ã¨æ€ã†ã“ã¨ã«ã—ã¦ã„ã‚‹ã€‚

## Keccak
Keccakã¯SHA3ã®ä¸­ã§ä½¿ã‚ã‚Œã‚‹ãƒãƒƒã‚·ãƒ¥åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€‚ãƒãƒƒã‚·ãƒ¥åŒ–ã¨ã¯è¦ã™ã‚‹ã«ã€ä»»æ„ã®é•·ã•ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã€ãã‚Œã‚’å†…éƒ¨ã§ãƒ“ãƒƒãƒˆçŠ¶æ…‹ã‚’ã‚ã‚‹ä¸€å®šã®æ“ä½œã‚’æ–½ã—ã¦ãã¡ã‚ƒãã¡ã‚ƒã«ã—ã¦å…ƒã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‹ã‚‰ãªã„ãã‚‰ã„ã¾ã§ãã¡ã‚ƒãã¡ã‚ƒã«ã™ã‚‹ã¨ã„ã†ã“ã¨ã€‚ä¸€å®šã®æ“ä½œãªã®ã§ã€åŒã˜ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã¯åŒã˜å‡ºåŠ›ãŒå¾—ã‚‰ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„ä¸€æ–¹ã§ã€å…ƒã«æˆ»ã›ãŸã‚‰æ€’ã‚‰ã‚Œã‚‹ã¨ã„ã†é›£ã—ã•ãŒã‚ã‚Šã¾ã™ã€‚

**SHA3ã«ãŠã‘ã‚‹**Keccakã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ã™ã”ãç°¡å˜ã«è¨€ã†ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã€‚

1. ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€å®šé‡å–å¾—ã™ã‚‹ã€‚ä»¥ä¸‹ã®æ“ä½œã¯ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªããªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™ã€‚
1. ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã€æ±ºã¾ã£ãŸæ“ä½œã‚’24å›ã™ã‚‹ã€‚
    - Î¸éç¨‹ã€Ïéç¨‹ã€Ï€éç¨‹ã€Ï‡éç¨‹ã€Î¹éç¨‹ã®é †ã«æ“ä½œã‚’è¡Œã†ã€‚ãã‚Œãã‚Œã®æ“ä½œã«ã¤ã„ã¦ã¯å¾Œè¿°
1. ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ããªããªã£ãŸã‚Šã€ä¸€å®šé‡ã«è¶³ã‚‰ãªããªã£ãŸã‚‰ã€æœ€å¾Œã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã†ã€‚ï¼ˆã“ã‚Œã¯ã™ãªã‚ã¡ã¡ã‚‡ã†ã©ä¸€å®šé‡å–ã£ã¦çµ‚ã‚ã‚‹ã‚ˆã†ãªã¨ãã«ã‚‚ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã†ã¨ã„ã†ã“ã¨ï¼‰
1. ã‚‚ã†ä¸€å›æ±ºã¾ã£ãŸæ“ä½œã‚’24å›ã™ã‚‹ã€‚
1. æ¬²ã—ã„åˆ†ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã€‚ï¼ˆãŸã ã—ã€SHAKEã¨å‘¼ã°ã‚Œã‚‹ä»»æ„ã®é•·ã•ã‚’å–å¾—ã™ã‚‹ã‚¿ã‚¤ãƒ—ã®ã‚‚ã®ã§ã¯ã€1å›ã§ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Šåˆ‡ã‚Œãªã„ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€å–å¾— -> 24å›ãã¡ã‚ƒãã¡ã‚ƒ -> å–å¾—ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ãŒã‚ã‚‹ï¼‰

ã“ã‚Œã ã‘ã§ã™ã€‚ç°¡å˜ã«è¦‹ãˆã‚‹ã—ã€å®Ÿéš›ãŸã ã“ã‚Œã‚’å®Ÿè£…ã™ã‚‹ã ã‘ãªã‚‰ãã‚“ãªã«é›£ã—ããªã„â€¦å¤šåˆ†ã€‚

<aside class="msg alert">
<span class="msg-symbol">ğŸ¤”</span>
<div class="msg-content">
ã¾ãåƒ•ã¯1æ—¥ã‹ã‹ã‚Šã¾ã—ãŸã‘ã©ã­ã€‚
</div>
</aside>

ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹éç¨‹ã‚’å¸åéç¨‹(absorb)ã¨å‘¼ã³ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹éç¨‹ã‚’ã‚¹ã‚¯ã‚¤ãƒ¼ã‚ºéç¨‹(squeeze)ã¨å‘¼ã³ã¾ã™ã€‚ã“ã‚Œã¯ã€Keccakå°‘ã—ãšã¤ãƒ‡ãƒ¼ã‚¿ã‚’è²¯ã‚ãªãŒã‚‰å†…éƒ¨ã§ãã¡ã‚ƒãã¡ã‚ƒã«ã—ã€ãã‚Œã‚’æœ€å¾Œã«çµã‚Šå‡ºã™æ§‹é€ ã‚’ã‚¹ãƒãƒ³ã‚¸æ§‹é€ ã¨å‘¼ã¶ã¨ã“ã‚ã‹ã‚‰æ¥ã¦ã„ã‚‹ã‚‰ã—ã„ã§ã™ã€‚

ä»¥ä¸‹ã«ã‚¹ãƒãƒ³ã‚¸æ§‹é€ ã®å›³ã‚’ç¤ºã—ã¾ã™ã€‚

![ã‚¹ãƒãƒ³ã‚¸æ§‹é€ ã®å›³](https://keccak.team/images/Sponge-150.png)

å…¥åŠ›ã¯`M`ã§è¡¨ã•ã‚Œã¦ã„ã¦ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸå¾Œã«ã€ä¸€å®šé‡ãšã¤å…¥ã‚Œã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`r`ãŒå…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã§`c`ã¯capacity blockã¨è¨€ã‚ã‚Œã€å…¥å‡ºåŠ›ã«ã¯é–¢ã‚ã‚‰ã‚Šã¾ã›ã‚“ã€‚ã“ã®éƒ¨åˆ†ã¯å„æ“ä½œæ™‚ã«ä¸€ç·’ã«æ“ä½œã•ã‚Œã‚‹å ´æ‰€ã§ã€ã“ã®éƒ¨åˆ†ã®ãƒ‡ã‚«ã•ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã‚ã£ã¦ã„ã‚‹ã‚‰ã—ã„ã€‚ã“ã®`r+c`ã®éƒ¨åˆ†ã‚’Keccakã®`state`ã¨å‘¼ã³ã¾ã™ã€‚å…¥åŠ›ã¯`state`ã®`r`ã®éƒ¨åˆ†ã¨XORã™ã‚‹ã“ã¨ã§å…¥åŠ›ã•ã‚Œã¾ã™ã€‚$f$ ã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã¯ä¸Šã«ç¤ºã—ãŸæ“ä½œã®éƒ¨åˆ†ã§ã™ã€‚

SHA3ã§ã¯ã€`state`ã¯ä¸€å¾‹ã§1600bitã§ã™ã€‚ã¾ãŸã€`c`ã®å®¹é‡ã¯SHA3-xxxã®xxxã®2å€ã¨æ±ºã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã€SHA3-512ã§ã‚ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

$$\begin{aligned}
  c &= 2 \times 512 = 1024 \\
  r &= 1600 - 1024 = 576
\end{aligned}$$

ã“ã®`r`ã®ã“ã¨ã‚’ã€rateã¨è¨€ã„ã¾ã™ã€‚å¾Œã§å…¥åŠ›ã‚’å‡¦ç†ã™ã‚‹ã¨ãã«å‡ºã¦ãã¾ã™ã€‚

$f$ã¯ã€Keccakã®å…¬å¼ã‚µã‚¤ãƒˆ[^2]ã®ä¸­ã§ä»¥ä¸‹ã®ã‚ˆã†ãªæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚å„é…åˆ—ã®indexã¯mod 5ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ï¼ˆä¾‹ãˆã°`x-1`ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã§ã€`x = 0`ã‚’ä»£å…¥ã™ã‚‹ã¨å®Ÿéš›ã®å€¤ã¯`4`ã«ãªã‚‹ã€‚ï¼‰

```rust
Keccak-f[b](A) {
  for i in 0..n-1
    A = Round[b](A, RC[i])
  return A
}

Round[b](A,RC) {
  # Î¸ step
  C[x] = A[x,0] xor A[x,1] xor A[x,2] xor A[x,3] xor A[x,4],   for x in 0..4
  D[x] = C[x-1] xor rot(C[x+1],1),                             for x in 0..4
  A[x,y] = A[x,y] xor D[x],                           for (x,y) in (0..4,0..4)

  # Ï and Ï€ steps
  B[y,2*x+3*y] = rot(A[x,y], r[x,y]),                 for (x,y) in (0..4,0..4)

  # Ï‡ step
  A[x,y] = B[x,y] xor ((not B[x+1,y]) and B[x+2,y]),  for (x,y) in (0..4,0..4)

  # Î¹ step
  A[0,0] = A[0,0] xor RC

  return A
}
```

`r[x,y]`ã¨`RC`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦è¡¨ã•ã‚Œã¾ã™ã€‚

```rust
const r: [[usize; 5]; 5] = [
    [0, 36, 3, 41, 18],
    [1, 44, 10, 45, 2],
    [62, 6, 43, 15, 61],
    [28, 55, 25, 21, 56],
    [27, 20, 39, 8, 14],
];

const RC: [u64; 24] = [
    0x0000000000000001, 0x0000000000008082, 0x800000000000808a,
    0x8000000080008000, 0x000000000000808b, 0x0000000080000001,
    0x8000000080008081, 0x8000000000008009, 0x000000000000008a,
    0x0000000000000088, 0x0000000080008009, 0x000000008000000a,
    0x000000008000808b, 0x800000000000008b, 0x8000000000008089,
    0x8000000000008003, 0x8000000000008002, 0x8000000000000080,
    0x000000000000800a, 0x800000008000000a, 0x8000000080008081,
    0x8000000000008080, 0x0000000080000001, 0x8000000080008008,
];

```

ã¾ãŸã€æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã®ä¸­ã§è¡¨ã•ã‚Œã¦ã„ã‚‹`rot`ã¯ã€bitã‚’å·¦å›è»¢ã™ã‚‹æ“ä½œã§ã™ã€‚ä¾‹ãˆã°ã€`b'10010'`ã‚’å·¦ã«2å›è»¢ã™ã‚‹ã¨`b'00101'`ã‚’çµŒã¦`b'01010'`ã«ãªã‚Šã¾ã™ã€‚

```rust
fn rotl64(x: u64, n: usize) -> u64 {
  if n == 0 {x} else {(x << n | (x >> (64 - n)))}
}
```

ã“ã®`rot`ã¯[specification](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf)é€šã‚Šã«å®Ÿè£…ã™ã‚‹ã¨ã€å³å›è»¢ã«ãªã‚‹ã®ã§ã™ãŒã€å¾Œè¿°ã™ã‚‹å…¥åŠ›ã«é–¢ã‚ã‚‹å‡¦ç†ã®éƒ½åˆä¸Šã€å·¦å›è»¢ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã§ã“ã®é–¢æ•°$f$ã®å®Ÿè£…ã¯**å¾Œã¯ã‚„ã‚‹ã ã‘**çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚ä»Šè€ƒãˆã‚‹ã¨ã€æœ€åˆã‹ã‚‰é“æ¨™ã‚’çŸ¥ã£ã¦ã„ã‚Œã°ã€æ€ã£ãŸã‚ˆã‚Šç°¡å˜ã€‚

ä»¥ä¸‹ã«å®Ÿéš›ã«å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã®ä¸­ã§ã€`state`ã¯æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹`A`ã§ã™ãŒã€1æ¬¡å…ƒé…åˆ—ã§ã‚ã‚Šã€`state[x + 5 * y]`ã§`A[x,y]`ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```rust
fn theta(state: &mut [u64]) {
    let mut c: [u64; 5] = [0; 5];
    let mut d: [u64; 5] = [0; 5];
    for x in 0..5 {
        c[x] = state[x] ^ state[x + 5] ^ state[x + 10] ^ state[x + 15] ^ state[x + 20];
    }
    for x in 0..5 {
        d[x] = c[(x + 4) % 5] ^ rotl64(c[(x + 1) % 5], 1);
    }
    for x in 0..5 {
        for y in 0..5 {
            state[x + 5 * y] ^= d[x];
        }
    }
}

fn rho(state: &mut [u64]) {
    let mut current: [u64; 25] = state.try_into().unwrap();
    for x in 0..5 {
        for y in 0..5 {
            current[x + 5 * y] = rotl64(state[x + 5 * y], ROT[x][y]);
        }
    }
    state.copy_from_slice(&current);
}

fn pi(state: &mut [u64]) {
    let mut current: [u64; 25] = state.try_into().unwrap();
    for x in 0..5 {
        for y in 0..5 {
            current[x + 5 * y] = state[(x + 3 * y) % 5 + 5 * x];
        }
    }
    state.copy_from_slice(&current);
}

fn chi(state: &mut [u64]) {
    let mut current: [u64; 25] = state.try_into().unwrap();
    for x in 0..5 {
        for y in 0..5 {
            current[x + 5 * y] =
                state[x + 5 * y] ^ ((!state[(x + 1) % 5 + 5 * y]) & state[(x + 2) % 5 + 5 * y]);
        }
    }
    state.copy_from_slice(&current);
}
```

### å…¥å‡ºåŠ›ã®æ–¹æ³•
ã‚ã¨ã¯å…¥å‡ºåŠ›ã‚’é©å½“ã«å‡¦ç†ã—ã¦ã‚ã’ã‚Œã°OKã§ã™ã€‚ã¾ãšã€å…¥å‡ºåŠ›ã®æµã‚Œã‚’æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã§ç¤ºã—ã¾ã™ã€‚å…¥åŠ›ã®æµã‚Œã¯ã•ã£ãã‚‚ç¤ºã—ã¾ã—ãŸãŒã€ä»Šåº¦ã¯æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã§ç¤ºã—ã¦ã¿ã¾ã™ã€‚

```rust
while input.len >= rate {
  state ^= input[0..rate]
  f(state)
  input = input[rate..]
}
input = pad(input)
state ^= input
```
ã“ã“ã§ã€`f`ã¯ã•ã£ãã®$f$ã§ã™ã€‚ã¾ãŸã€`rate`ã¨ã¯ã€SHA3-xxxã®xxxã«ã‚ˆã£ã¦ç•°ãªã‚‹ä¸€åº¦ã«å—ã‘å…¥ã‚Œã‚‹å…¥åŠ›bitæ•°ã®ã“ã¨ã§ã™ã€‚`pad`ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã†é–¢æ•°ã§ã™ã€‚

1ã¤ãƒã‚¤ãƒ³ãƒˆãªã®ã¯ã€`while`æ–‡ã®æ¡ä»¶ãŒ`input.len >= rate` ãªã“ã¨ã§ã™ã€‚ã¤ã¾ã‚Šã€å…¥åŠ›ãŒã¡ã‚‡ã†ã©å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹bitæ•°ã¨ç­‰ã—ãã¦ã‚‚ã€`f`ã‚’ä¸€å›å®Ÿè¡Œã—ã¦ã‹ã‚‰ç©ºã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ã“ã¨ã§ã€å¶ç„¶ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã„ã‚‰ãšã ã£ãŸãƒ‡ãƒ¼ã‚¿ã¨ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…è¦ã ã£ãŸãƒ‡ãƒ¼ã‚¿ãŒåŒã˜å‡ºåŠ›ã«ãªã‚‹ã“ã¨ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¯ç°¡å˜ã§ã€SHA3-xxxã®ã¨ãã¯ã€çµ‚ç«¯ã«SHA3ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ï¼ˆå¯å¤‰é•·å‡ºåŠ›ã®SHAKEã§ãªã„ã“ã¨ã‚’ç¤ºã™ï¼‰ãŸã‚ã«`b'01'`ã‚’è¶³ã—ã¦ã‹ã‚‰ã€ãã®å¾Œã«`b'10.....01'`ã¨ã™ã‚‹ã ã‘ã§ã™ã€‚ã“ã‚Œã‚‰ã‚’è¶³ã—åˆã‚ã›ã¦ã€SHA3ã§ã¯inputã®å¾Œã«`b'0110.....01'`ã‚’è¶³ã—ã¦ã„ã¾ã™ã€‚

ã§ã¯ã€å®Ÿéš›ã®åƒ•ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```rust
pub fn keccak_absorb_once(state: &mut [u64], rate: usize, input: &[u8], mut len: usize, pad: u8) {
    //state initialization
    for i in state.iter_mut() {
        *i = 0;
    }

    let mut idx: usize = 0;
    //é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’rate byteãšã¤å¸åã™ã‚‹
    while len >= rate {
        //64bit = 8byteãšã¤å¸åã™ã‚‹
        for i in 0..rate / 8 {
            //inputã‚’little endian 64bitã¨ã—ã¦stateã«xorã™ã‚‹
            state[i] ^= u64::from_le_bytes(input[idx..idx + 8].try_into().unwrap());
            idx += 8;
        }
        len -= rate;
        //çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
        keccak_f1600(state);
    }
    //æ®‹ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¸åã™ã‚‹
    for i in 0..len {
        state[i / 8] ^= (input[idx + i] as u64) << (8 * (i % 8));
    }
    //å…ˆé ­ã«padã‚’ã¤ã‘ã‚‹
    state[len / 8] ^= (pad as u64) << (8 * (len % 8));
    //æœ€å¾Œã®ãƒ–ãƒ­ãƒƒã‚¯ã«å¯¾ã—ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã†
    state[rate / 8 - 1] ^= 1u64 << 63;
}
```

ã“ã“ã§ã€å…¥åŠ›ã«ã‚ã‚‹`pad`ã¨ã¯ã€`SHA`ã ã£ãŸã‚‰`0x06`ã€`SHAKE`ã ã£ãŸã‚‰`0x1f`ã§ã™ã€‚ã“ã‚Œã¯ã•ã£ãè¨€ã£ãŸpaddingéƒ¨åˆ†`'b0110...01`ã‚’æ€ã„å‡ºã—ã¦ãã‚Œã‚Œã°ã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã‚Œã¯ãã†ã¨ã—ã¦ã€

```rust
    //å…ˆé ­ã«padã‚’ã¤ã‘ã‚‹
    state[len / 8] ^= (pad as u64) << (8 * (len % 8));
    //æœ€å¾Œã®ãƒ–ãƒ­ãƒƒã‚¯ã«å¯¾ã—ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã†
    state[rate / 8 - 1] ^= 1u64 << 63;
```
ãŒã€æ„å‘³ã‚ã‹ã‚‰ã‚“ã‚ã¨ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚å°‘ã—ãšã¤æ•´ç†ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

å®Ÿã¯ã€Keccakã¨SHA3ã§ã¯ã€ãƒ“ãƒƒãƒˆé †ï¼ˆâ‰ ãƒã‚¤ãƒˆé †ï¼‰ãŒç•°ãªã‚Šã¾ã™ã€‚é©šãã¹ãã“ã¨ã§ã™ãŒã€SHA-3ã§ã¯MSBãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§ã€Keccakã§ã¯LSBãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã¿ãŸã„ã§ã™ã€‚ã“ã‚Œã¯NICTãŒãªã‚“ã‹ã—ã‚‰ã‚“ã‘ã©ãã†ã—ãŸã¿ãŸã„ã§ã™ã€‚[^3]

ã¤ã¾ã‚Šã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã†ã¨ã€ä¾‹ãˆã°ã€`b'1001_1100'`ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ãŸã‚‰Keccakã®ä¸­ã§ã¯ã€`'b0011_1100'`ã«ä¸¦ã¹ç›´ã•ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚ã“ã®ã¨ãã€byteé †ã¯å…¥ã‚Œæ›¿ã‚ã‚Šã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€`b'1001_1100_1010_0011'`ã¯`b'0011_1001_1100_0101'`ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ã§ã€ã“ã®ã‚ã¨ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒå…¥ã‚‹â€¦ã€‚

ã—ã‹ã—ã€å®Ÿéš›ã«ã¯byteã”ã¨ã«bitã®é †ç•ªã‚’åè»¢ã•ã›ã‚‹ãªã‚“ã¦æ“ä½œã‚’ã‚„ã£ã¦ã„ãŸã‚‰æ—¥ãŒæš®ã‚Œã¾ã™ã€‚ãã“ã§ã©ã†ã™ã‚‹ã‹ã¨ã„ã†ã¨ã€**paddingã‚’è¾¼ã¿ã§ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§èª­ã¿è¾¼ã¾ã›ã‚‹**ã¨ã„ã†æ‰‹æ³•ã§ã™ã€‚[^4]

ä»Šã€1byteã®å…¥åŠ›ã‚’å—ã‘å–ã‚Šã€SHA3-256ã ã¨ã™ã‚‹ã¨ã€æœ€å¾Œã®æ“ä½œã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```rust
//ãƒ¡ãƒƒã‚»ãƒ¼ã˜ã®å¸åã‚’ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§è¡Œã†
state[0] ^= input[0] as u64 << (8 * 0);
//ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹åŸ‹ã‚è¾¼ã¿
state[0] ^= (pad as u64) << (8 * 1);
//ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†åŸ‹ã‚è¾¼ã¿
state[16] ^= 1u64 << 63;
```
ã“ã®ã“ã¨ã‹ã‚‰ã‚ã‹ã‚‹ã®ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…ãšã€æœ€å¾Œã«å¸åã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®1ã¤ä¸Šã®byteã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ã¾ãŸã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®çµ‚ã‚ã‚Šã¯å¿…ãšã€æœ€å¾Œã®64byteã®MSBã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```
//ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã‚ã¨ã®state[0]ã¯ã“ã‚“ãªæ„Ÿã˜
b'00000000_00000000_00000000_00000000_00000000_00000000_00000110_00010110'
//ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã‚ã¨ã®state[16]ã¯ã“ã‚“ãªæ„Ÿã˜
b'10000000_00000000_00000000_00000000_00000000_00000000_00000000_00000000'
```
ç¢ºã‹ã«ã“ã‚Œã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®é–‹å§‹ã‚‚ã€çµ‚ã‚ã‚Šã‚‚ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã§ã€ã“ã®å¾Œã®æ“ä½œã§å¿…è¦ã«ãªã‚‹ã€XORã‚„ANDã€NOTã®æ“ä½œã¯ãƒ“ãƒƒãƒˆé †ã«å½±éŸ¿ã‚’å—ã‘ãªã„ãŸã‚ã€Î¸éç¨‹ã‚„ã€Ïéç¨‹ã®ãƒ“ãƒƒãƒˆå›è»¢ã®æ“ä½œã ã‘ã€åå¯¾ã«ã™ã‚Œã°å•é¡Œãªã„ã‚‰ã—ã„ã§ã™ã€‚å®Ÿéš›ã“ã‚Œã§ã†ã¾ãã„ãã®ã§ã™ãŒã€ãªã‚“ã‚„ã“ã‚Œã€‚

#### ã“ã†è€ƒãˆã‚Œã°è‰¯ã„

ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§èª­ã¿è¾¼ã‚“ã ã“ã¨ã§ã€å¬‰ã—ã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯ã€LSBãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®åŠ¹æœãŒå¾—ã‚‰ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ã¤ã¾ã‚Šã“ã†ã„ã†ã“ã¨ã§ã™ã€‚
```
//MSB
b'00110011_11001100_10101010_01010101_00000000_00000000_00000000_00000000'

//LSB
b'11001100_00110011_01010101_10101010_00000000_00000000_00000000_00000000'

//little endianã§èª­ã¿è¾¼ã‚€MSB
b'00000000_00000000_00000000_00000000_01010101_10101010_11001100_00110011'
```

little endianã‚’å¾Œã‚ã‹ã‚‰è¦‹ã¦ã‚ã’ã‚‹ã¨LSBãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã«ãªã£ã¦ã‚‹ã‚„ã‚“ï¼ã ã‹ã‚‰ã“ã‚Œã«æ“ä½œã—ã¦ã‚ã’ã¦ï¼ˆãŸã ã—å›è»¢ã ã‘é€†æ–¹å‘ã«ã—ã¦ã‚ã’ã‚‹ï¼‰æœ€å¾Œã«å‡ºåŠ›ã—ã¦ã‚ã’ã‚Œã°åŒã˜ã‚„ã‚“ï¼ã¨ãªã£ã¦ã¿ã‚“ãªãƒãƒƒãƒ”ãƒ¼ã§ã™ã­ã€‚ãã†ã€å›è»¢ã‚’é€†æ–¹å‘ã«ã™ã‚‹ã¨ã„ã†ã®ã¯ã€å³ã‹ã‚‰LSBãŒä¸¦ã‚“ã§ã‚‹ã¿ãŸã„ãªçŠ¶æ…‹ã«ãªã£ã¦ã‚‹ã‹ã‚‰ã ã£ãŸã®ã§ã™ã€‚ãªããƒ¼ã‚“ã ã€‚

---

å‡ºåŠ›ã¯ç°¡å˜ã§ã€`state`ã‹ã‚‰å¿…è¦ãªé•·ã•ã ã‘å–ã‚Šå‡ºã›ã°ã„ã„ã ã‘ã§ã™ã€‚ãŸã ã—ã€å‡ºåŠ›ã¯`[u8; 32]`ãªã©ã«å¯¾ã—ã¦ã€`state`ã¯`[u64; 25]`ãªã®ã§ã€å¤‰æ›ã—ã¦å–ã‚Šå‡ºã—ã¾ã™ã€‚ã“ã‚Œã‚‚ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§è‰¯ã„ã§ã™ã€‚ã˜ã‚ƒã‚ã‚‚ã†ä¸€å›ä¸Šã®ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä»Šå‡ºåŠ›ã¨ã—ã¦little endianã§èª­ã¿è¾¼ã‚€MSBã®å‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚æœ¬æ¥ã§ã‚ã‚Œã°LSBã®å½¢ã§å‡ºã¦ãã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å„byteã«é–¢ã—ã¦bité †ã‚’åè»¢ã—ã¦å–ã‚Šå‡ºã—ã€MSBã®ã‚„ã¤ãŒå¾—ãŸã„ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚ãã“ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å–ã‚Šå‡ºã™ã¨ã€ã—ã£ã‹ã‚Šä¸‹ã‹ã‚‰MSBã«ãªã‚‹ã‚ˆã†ã«å–ã‚Šå‡ºã›ã¦ã„ã‚‹ã“ã¨ãŒãŠã‚ã‹ã‚Šã„ãŸã ã‘ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```rust
pub fn sha3_256(out: &mut [u8; 32], input: &[u8], len: usize) {
    let mut state: [u64; 25] = [0; 25]; //state 1600 bits
    keccak_absorb_once(&mut state, SHA_256_RATE, input, len, 0x06);
    keccak_f1600(&mut state);
    for i in 0..32 {
        out[i] = (state[i / 8] >> (8 * (i % 8))) as u8;
    }
}
```

## ã¾ã¨ã‚
SHA3ã®Specificationã‚„ã€Keccakãƒãƒ¼ãƒ ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰ã€Rustã§SHA3ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚å†…éƒ¨ã®çŠ¶æ…‹é·ç§»ã“ãç°¡å˜ã§ã™ãŒã€å…¥å‡ºåŠ›å‘¨ã‚ŠãŒã‚ã¾ã‚Šã«ã‚‚è¤‡é›‘ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€æ­£ç›´å«Œã„ã§ã™ã€‚LSBã ã‹MSBã ã‹çŸ¥ã‚‰ãªã„ãŒçµ±ä¸€ã—ã¦æ¬²ã—ã„ã—ã€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…ãŒã€Specificationã¨å®Œå…¨ã«åˆè‡´ã—ãªã„æ–¹æ³•ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã‚‚ãã‚Œã¯ã©ã†ãªã®ï¼Ÿã¨ã„ã†æ°—æŒã¡ã«ãªã‚Šã¾ã™ã€‚

NICTã¯ã“ã®SHA3ã®ç­–å®šã«ã‚ãŸã£ã¦è‰²ã€…ä»–ã«ã‚‚ãƒˆãƒ©ãƒ–ã£ãŸã¿ãŸã„ã§ã™ãŒã€ï¼ˆWikipediaå‚ç…§ã—ã¦ãã ã•ã„ï¼‰ã›ã‚ã¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«é–¢ã—ã¦ã¯ã‚‚ã†å°‘ã—ã¾ã¨ã‚‚ã«ã—ã‚ã¨æ€ã„ã¾ã—ãŸã€‚ã“ã®æ™‚æœŸã®NICTã«ãªã‚“ã‹ã‚ã£ãŸã‚“ã§ã™ã‹ã­ã€ã—ã‚‰ã‚“ã‘ã©ã€‚

ã§ã‚‚å®Ÿéš›MSBã ãŒLSBã ã‹ã©ã£ã¡ã§ã‚‚ã€å†…éƒ¨ã®ãã¡ã‚ƒãã¡ã‚ƒã«ã™ã‚‹éƒ¨åˆ†ã¯å¤‰ã‚ã‚‰ãªã„ã®ã§ã€åƒ•ã¯ãã‚ŒãŒè‰¯ã„ã¨æ€ã£ã¦ã„ã‚‹ã‚“ã§ã™ãŒã€ãªã‚“ã§ã“ã†ã‚‚è¤‡é›‘ã«ã—ãŸã‚“ã§ã—ã‚‡ã†ã‹ã€‚Keccakãƒãƒ¼ãƒ ãŒNICTæ¨™æº–ã«åˆã‚ã›ã‚‹ã®ãŒã ã‚‹ã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒâ€¦ã€‚

æœ€å¾Œã«ã€ã“ã®è¨˜äº‹ã®ä¸­ã§2åº¦å¼•ç”¨ã—ãŸç­†è€…ã®è¨˜äº‹[^3]ã‚ˆã‚Šã€ã“ã‚“ãªè¨€è‘‰ã‚’å¼•ç”¨ã—ã¦çµ‚ã‚ã‚Šã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

> Let me tell you: FIPS 202's explanation makes no sense.
> 
> æ•™ãˆã¦ã‚ã’ã‚ˆã†ï¼šFIPS 202ï¼ˆSHA3ã®ä»•æ§˜æ›¸ï¼‰ã®èª¬æ˜ã¯æ„å‘³ä¸æ˜ã ã€‚

---
{: data-content="footnotes"}

[^1]: [https://csrc.nist.gov/publications/detail/fips/202/final](https://csrc.nist.gov/publications/detail/fips/202/final)
[^2]: [https://keccak.team/keccak_specs_summary.html](https://keccak.team/keccak_specs_summary.html)
[^3]: [https://www.cryptologie.net/article/386/sha3-3-keccak-and-disturbing-implementation-stories/](https://www.cryptologie.net/article/386/sha3-3-keccak-and-disturbing-implementation-stories/)ã™ã¹ã¦ã®æ··ä¹±ã¯ã“ã„ã¤ã®ã›ã„ã ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚TSL1.3ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚»ã‚¹ã‚’è¸ã‚€ã¹ãã§ã€SHA3ã¯å®Ÿè³ªçš„ã«ãƒ¬ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…ã‚’è¦‹ãªã‘ã‚Œã°ã€èª°ã‚‚ç†è§£ã§ããªã„ã¨è¨€ã£ã¦ã„ã‚‹ã€‚
[^4]: [https://cryptologie.net/article/387/byte-ordering-and-bit-numbering-in-keccak-and-sha-3/](https://cryptologie.net/article/387/byte-ordering-and-bit-numbering-in-keccak-and-sha-3/)ã“ã“ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹æ‰‹æ³•ã§ã€ãƒ¬ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…ã‚‚å¤§ä½“ã®å®Ÿè£…ã‚‚ã“ã®æ–¹æ³•ã§ã‚„ã£ã¦ã„ã‚‹ã¨è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã€‚
